class o{constructor(){this.swRegistration=null,this.publicKey=null,this.isSubscribed=!1}async init(){if(!(document.querySelector('meta[name="csrf-token"]')&&document.body.dataset.authenticated!=="false"))return console.log("User not authenticated, skipping push notification initialization"),!1;if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.warn("Push notifications are not supported in this browser"),!1;try{return this.swRegistration=await navigator.serviceWorker.ready,await this.fetchPublicKey(),await this.checkSubscription(),!0}catch(t){return console.error("Error initializing push notifications:",t),!1}}async fetchPublicKey(){try{const e=document.querySelector('meta[name="csrf-token"]');if(!e)throw new Error("CSRF token not found");const t=await fetch("/api/push/public-key",{headers:{Accept:"application/json","X-CSRF-TOKEN":e.content},credentials:"same-origin"});if(!t.ok)throw t.status===401?new Error("User not authenticated"):new Error(`Failed to fetch public key: ${t.status}`);const r=await t.json();this.publicKey=r.publicKey}catch(e){throw console.error("Error fetching public key:",e),e}}async checkSubscription(){try{const e=await this.swRegistration.pushManager.getSubscription();return this.isSubscribed=e!==null,this.isSubscribed}catch(e){return console.error("Error checking subscription:",e),!1}}async subscribe(){try{if(await Notification.requestPermission()!=="granted")return console.log("Notification permission denied"),{success:!1,message:"Permission denied"};let t=await this.swRegistration.pushManager.getSubscription();if(!t){const r=this.urlBase64ToUint8Array(this.publicKey);t=await this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:r})}return await this.sendSubscriptionToServer(t),this.isSubscribed=!0,{success:!0,message:"Subscribed successfully"}}catch(e){return console.error("Error subscribing to push notifications:",e),{success:!1,message:e.message}}}async unsubscribe(){try{const e=await this.swRegistration.pushManager.getSubscription();return e&&(await e.unsubscribe(),await this.removeSubscriptionFromServer(e),this.isSubscribed=!1),{success:!0,message:"Unsubscribed successfully"}}catch(e){return console.error("Error unsubscribing from push notifications:",e),{success:!1,message:e.message}}}async sendSubscriptionToServer(e){try{const t=await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},credentials:"same-origin",body:JSON.stringify(e.toJSON())});if(!t.ok)throw new Error("Failed to send subscription to server");return await t.json()}catch(t){throw console.error("Error sending subscription to server:",t),t}}async removeSubscriptionFromServer(e){try{const t=await fetch("/api/push/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},credentials:"same-origin",body:JSON.stringify({endpoint:e.endpoint})});if(!t.ok)throw new Error("Failed to remove subscription from server");return await t.json()}catch(t){throw console.error("Error removing subscription from server:",t),t}}urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),r=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(r),n=new Uint8Array(s.length);for(let i=0;i<s.length;++i)n[i]=s.charCodeAt(i);return n}getPermissionStatus(){return"Notification"in window?Notification.permission:"unsupported"}isSupported(){return"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window}}window.pushNotificationManager=new o;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.pushNotificationManager.init()}):window.pushNotificationManager.init();
